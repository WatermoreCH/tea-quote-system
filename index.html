<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>茶匯公司 | 專業報價系統</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LcivkQsAAAAAHwFJqqT6KHphabDFuYsm2d8t915"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f6f3; }
        .hero-spotlight { background: radial-gradient(circle at 20% 30%, rgba(197, 160, 89, 0.2) 0%, transparent 50%), #1A302B; }
        .gold-value-block { background: linear-gradient(145deg, #D4B475 0%, #C5A059 100%); }
        .card-active { border: 4px solid #1A302B !important; background-color: #fffdf5 !important; box-shadow: 0 10px 20px rgba(197,160,89,0.3); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body x-data="quoteSystem()" class="text-slate-900 leading-relaxed">

    <header class="hero-spotlight text-white py-12 px-6 text-center">
        <h1 class="text-3xl md:text-6xl font-black mb-4">茶包客製化 <span class="text-[#C5A059]">正式報價</span> 系統</h1>
        <p class="text-slate-300">請選擇規格並獲取正式 PDF 報價單</p>
    </header>

    <main class="max-w-7xl mx-auto py-10 px-4 md:px-6 grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-7 space-y-10">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h2 class="text-xl font-black mb-6">02 選擇客製方案</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <template x-for="plan in allPlans" :key="plan.id">
                        <button @click="selectPlan(plan)"
                            :class="selectedPlanId === plan.id ? 'card-active' : 'bg-slate-50 border-transparent'"
                            class="py-6 rounded-xl border-4 transition-all flex flex-col items-center">
                            <span class="text-[10px] font-black opacity-60">方案 <span x-text="plan.id"></span></span>
                            <span class="font-bold text-sm" x-text="plan.name"></span>
                            <span class="text-[10px] mt-1">起訂: <span x-text="plan.moq"></span></span>
                        </button>
                    </template>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h2 class="text-xl font-black mb-6">03 選擇內袋材質</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="mat in materials" :key="mat.name">
                        <button @click="selectedMaterial = mat"
                            :class="selectedMaterial.name === mat.name ? 'card-active' : 'bg-slate-50'"
                            class="p-5 rounded-2xl border-4 transition-all flex justify-between items-center">
                            <span class="font-bold" x-text="mat.name"></span>
                            <span class="text-[#1A302B] font-black">+$<span x-text="mat.surcharge.toFixed(1)"></span></span>
                        </button>
                    </template>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <h2 class="text-xl font-black mb-6">05 設定訂購數量</h2>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-3 mb-6">
                    <template x-for="qty in qtyOptions" :key="qty">
                        <button @click="quantity = qty"
                            x-show="qty >= minMoq"
                            :class="quantity === qty ? 'bg-slate-900 text-white' : 'bg-slate-100'"
                            class="py-4 rounded-xl font-bold" x-text="qty.toLocaleString()">
                        </button>
                    </template>
                </div>
                <div class="bg-slate-50 p-6 rounded-3xl border-2">
                    <label class="block text-xs font-black text-slate-400 mb-3 text-center uppercase">手動輸入自訂數量</label>
                    <div class="relative max-w-xs mx-auto">
                        <input type="number" x-model.number="quantity" :min="minMoq"
                            class="w-full px-8 py-4 bg-white border-4 border-slate-200 rounded-2xl font-black text-2xl text-center focus:border-[#C5A059] outline-none">
                        <span class="absolute right-6 top-1/2 -translate-y-1/2 font-bold text-slate-400">包</span>
                    </div>
                    <p class="text-xs text-red-500 mt-3 text-center font-bold" x-show="quantity < minMoq">
                        ⚠️ 此方案最低起訂量為 <span x-text="minMoq.toLocaleString()"></span> 包
                    </p>
                </div>
            </div>
        </div>

        <aside class="lg:col-span-5 sticky top-8">
            <div class="bg-[#1A302B] rounded-[2.5rem] p-8 text-white shadow-2xl">
                <div class="gold-value-block p-8 rounded-[2.5rem] text-[#1A302B] mb-8">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-sm font-black">單價參考</span>
                        <span class="text-4xl font-black" x-text="'NT$ ' + finalUnitPrice"></span>
                    </div>
                    <div class="pt-4 border-t border-[#1A302B]/20 text-center">
                        <span class="text-sm font-black opacity-80">預估總金額</span>
                        <div class="text-5xl font-black mt-2">NT$ <span x-text="totalPrice.toLocaleString()"></span></div>
                    </div>
                </div>
                <button @click="if(quantity < minMoq) { alert('低於起訂量'); return; } showForm = true"
                    class="w-full bg-[#C5A059] text-[#1A302B] py-6 rounded-3xl font-black text-2xl">產出報價單</button>
            </div>
        </aside>

        <section x-show="showForm" class="lg:col-span-12 mt-10 bg-white p-10 rounded-[3rem] shadow-xl" x-cloak>
            <h2 class="text-3xl font-black text-center mb-10">接收報價單資訊</h2>
            <form @submit.prevent="handleSubmit" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <input type="text" x-model="formData.company" required placeholder="公司抬頭 / 統編" class="p-5 bg-slate-50 rounded-2xl font-bold border-none">
                <input type="text" x-model="formData.name" required placeholder="聯絡人姓名" class="p-5 bg-slate-50 rounded-2xl font-bold border-none">
                <input type="email" x-model="formData.email" required placeholder="電子信箱" class="p-5 bg-slate-50 rounded-2xl font-bold border-none">
                <input type="text" x-model="formData.contact" required placeholder="LINE ID / 電話" class="p-5 bg-slate-50 rounded-2xl font-bold border-none">
                <button type="submit" :disabled="loading" class="md:col-span-2 bg-slate-900 text-white py-6 rounded-3xl font-black text-xl flex justify-center">
                    <span x-show="!loading">確認規格並寄信</span>
                    <span x-show="loading" class="animate-pulse">正在處理中...</span>
                </button>
            </form>
        </section>
    </main>

    <div x-show="showSuccess" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-6" x-cloak>
        <div class="bg-white p-12 rounded-[3rem] text-center max-w-lg w-full">
            <div class="text-6xl mb-6">✅</div>
            <h3 class="text-3xl font-black mb-4">報價單已成功寄送</h3>
            <p class="font-bold text-slate-600 mb-8">PDF 已同步發送至您的 Email：<br><span x-text="formData.email" class="text-slate-900"></span></p>
            <button @click="showSuccess = false; showForm = false" class="bg-slate-900 text-white px-10 py-4 rounded-full font-black">關閉視窗</button>
        </div>
    </div>

    <script>
        function quoteSystem() {
            return {
                selectedPlanId: 'C',
                selectedPlan: { id: 'C', name: '盒裝基本', base: 3.00, moq: 4500, canBox: true },
                selectedMaterial: { name: '尼龍（有線）', surcharge: 1.2, type: '有線' },
                quantity: 4500,
                showForm: false, loading: false, showSuccess: false,
                formData: { company: '', name: '', email: '', contact: '' },
                quoteNumber: '',
                gasUrl: 'https://script.google.com/macros/s/AKfycbzAQ4XA5e1I2rCBjX9x7XEjA6m2qB8egcRUtFm_j_Vb3N2iQ5lm2FhhK_O--Xur_c-5/exec', // <--- 這裡記得填網址

                allPlans: [
                    { id: 'A', name: '單包基本', base: 5.63, moq: 550, canBox: false },
                    { id: 'B', name: '單包進階', base: 5.63, moq: 550, canBox: false },
                    { id: 'C', name: '盒裝基本', base: 3.00, moq: 4500, canBox: true },
                    { id: 'D', name: '盒裝進階', base: 2.80, moq: 15000, canBox: true },
                    { id: 'E', name: '客製規格', base: 0, moq: 0, canBox: true }
                ],
                materials: [
                    { name: '尼龍（有線）', surcharge: 1.2 }, { name: '玉米纖維（有線）', surcharge: 1.2 },
                    { name: '不織布（有線）', surcharge: 1.2 }, { name: '尼龍（無線）', surcharge: 1.0 },
                    { name: '不織布（無線）', surcharge: 0.7 }
                ],
                qtyOptions: [550, 1000, 2000, 4500, 10000, 20000],

                selectPlan(plan) {
                    this.selectedPlanId = plan.id;
                    this.selectedPlan = plan;
                    if (this.quantity < plan.moq) this.quantity = plan.moq;
                },
                get minMoq() { return this.selectedPlan.moq || 0; },
                get finalUnitPrice() {
                    if (this.selectedPlanId === 'E') return "專案報價";
                    let price = this.selectedPlan.base + this.selectedMaterial.surcharge + (this.quantity < 2000 ? (this.quantity < 1000 ? 0.8 : 0.3) : 0);
                    if (this.quantity >= 20000) price *= 0.8; else if (this.quantity >= 10000) price *= 0.9;
                    return price.toFixed(2);
                },
                get totalPrice() {
                    if (this.selectedPlanId === 'E' || this.quantity < this.minMoq) return 0;
                    return Math.round(parseFloat(this.finalUnitPrice) * this.quantity) + (this.selectedPlan.canBox ? 825 : 0);
                },

                async handleSubmit() {
                    this.loading = true;
                    try {
                        const recaptchaToken = await new Promise((resolve) => {
                            grecaptcha.ready(() => {
                                grecaptcha.execute('6LcivkQsAAAAAHwFJqqT6KHphabDFuYsm2d8t915', {action: 'submit'}).then(resolve);
                            });
                        });

                        this.quoteNumber = `QT-${new Date().getTime().toString().slice(-8)}`;
                        const payload = {
                            action: 'saveQuote',
                            recaptchaToken: recaptchaToken,
                            quoteNumber: this.quoteNumber,
                            customer: this.formData,
                            params: { planId: this.selectedPlanId, materialName: this.selectedMaterial.name, quantity: this.quantity }
                        };

                        const res = await fetch(this.gasUrl, { method: 'POST', body: JSON.stringify(payload) });
                        const data = await res.json();
                        if (data.success) { this.showSuccess = true; } else { alert('提交失敗：' + data.msg); }
                    } catch (e) { alert('連線異常，請檢查後端部署。'); } finally { this.loading = false; }
                },
                getPlanBg(id) {
                    const colors = { 'A': 'bg-red-50 text-red-700', 'B': 'bg-orange-50 text-orange-700', 'C': 'bg-yellow-50 text-yellow-700', 'D': 'bg-emerald-50 text-emerald-700', 'E': 'bg-blue-50 text-blue-700' };
                    return colors[id];
                }
            }
        }
    </script>
</body>
</html>